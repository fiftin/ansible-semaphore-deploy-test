- name: Remove previous version
  file:
    path: /tmp/demo-app-src
    state: absent

- name: Get app's source code
  git:
    repo: https://github.com/fiftin/ansible-semaphore-test-app.git
    dest: /tmp/demo-app-src
    force: yes

- name: Print Test Var value
  debug:
    msg: "{{ test_var }}"

- name: Build app
  lineinfile:
    path: /tmp/demo-app-src/index.html
    backrefs: yes
    search_string: "{{ item.tpl }}"
    line: "{{ item.value }}"
  with_items:
  - tpl: "<!-- test_var -->"
    value: "{{ test_var }}"
  - tpl: "<!-- version -->"
    value: "{{ semaphore_vars.task_details.target_version }}"
    
- name: Create build archive
    path: /tmp/demo-app-src/*
    dest: /tmp/build-v{{ semaphore_vars.task_details.target_versio }}.tar.gz

- name: Copy app to S3 storage
  community.aws.s3_sync:
    endpoint_url: "{{ secrets.aws_url }}"
    bucket: "{{ secrets.aws_bucket }}"
    aws_access_key: "{{ secrets.aws_access_key }}"
    aws_secret_key: "{{ secrets.aws_access_secret }}"
    region: "{{ secrets.aws_region }}"
    file_root: /tmp/build-v{{ semaphore_vars.task_details.target_versio }}.tar.gz
    file_change_strategy: force